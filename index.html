<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Cadence Metronome</title>
<meta name="robots" content="noindex,nofollow">
<style>
  :root{--bg:#0b0b0b;--card:#151515;--fg:#eaeaea;--muted:#9aa0a6;--brand:#2563eb}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:560px;margin:0 auto;padding:26px 18px}
  h1{margin:0 0 10px;font-size:22px}
  .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:12px 0}
  .col{display:flex;flex-direction:column;gap:10px}
  .big{font-variant-numeric:tabular-nums;font-size:40px;font-weight:800}
  input[type=range]{width:100%}
  input[type=number]{width:110px;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:10px;color:var(--fg);padding:8px 10px;font-size:16px}
  button{background:#2a2a2a;border:none;border-radius:12px;padding:10px 14px;color:#fff;font-weight:600}
  button.primary{background:var(--brand)}
  .chip{padding:8px 12px;border-radius:999px;background:#222}
  .preset{min-width:64px}
  .hint{opacity:.75;font-size:13px;margin-top:8px}
  .group{display:flex;flex-wrap:wrap;gap:8px}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  .toggle input{transform:scale(1.2)}
</style>
</head>
<body>
<audio id="bgAudio" src="silence.wav" loop playsinline style="display:none"></audio>  
<div class="wrap">
  <h1>Cadence Metronome</h1>
  <div class="card">
    <div class="row">
      <div class="col">
        <div class="row" style="justify-content:flex-start;gap:12px">
          <div class="chip">Target steps/min (SPM)</div>
          <input id="spmInput" type="number" min="120" max="300" step="1" value="180">
          <label class="toggle"><input id="halfRate" type="checkbox" checked> 2 steps/click (Half rate)</label>
        </div>
        <div class="row">
          <input id="spmSlider" type="range" min="120" max="300" value="180" step="1">
        </div>
      </div>
      <div class="big" id="playBpmLabel">90</div>
    </div>

    <div class="group">
      <button id="minus10">−10</button>
      <button id="minus5">−5</button>
      <button id="minus1">−1</button>
      <button id="plus1">+1</button>
      <button id="plus5">+5</button>
      <button id="plus10">+10</button>
      <button id="toggle" class="primary" style="margin-left:auto">Start</button>
    </div>

    <div class="group" style="margin-top:6px">
      <button class="preset" data-spm="160">160</button>
      <button class="preset" data-spm="170">170</button>
      <button class="preset" data-spm="180">180</button>
      <button class="preset" data-spm="190">190</button>
      <button class="preset" data-spm="200">200</button>
      <button class="preset" data-spm="220">220</button>
      <button class="preset" data-spm="240">240</button>
      <button class="preset" data-spm="260">260</button>
      <button class="preset" data-spm="280">280</button>
      <button class="preset" data-spm="300">300</button>
    </div>

    <div class="group" style="margin-top:12px">
      <span class="chip">Sound:</span>
      <button id="soundClick">Click</button>
      <button id="soundWood">Wood</button>
      <button id="soundDrum">Drum</button>
      <button id="accent">Accent 1/4</button>
    </div>

    <div class="hint">Tip: Add to Home Screen (Safari → Share → “Add to Home Screen”) to use offline. “Play BPM” shows the actual click rate (SPM or SPM/2).</div>
  </div>
</div>

<script>
// --- PWA offline cache (service worker, inline) ---
if ('serviceWorker' in navigator) {
  const sw = `
    self.addEventListener('install', e => {
      e.waitUntil(caches.open('cadence-v2').then(c=>c.addAll(['./','silence.wav'])));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  const blob = new Blob([sw], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

// --- Metronome engine (Web Audio with tight scheduling) ---
let audioCtx, gainMain, gainAccent;
let nextTime = 0, isRunning = false, playBpm = 90, spm = 180, count = 0;
let sound = 'click', accentOn = true;

function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const master = audioCtx.createGain(); master.gain.value = 0.9; master.connect(audioCtx.destination);
  gainMain = audioCtx.createGain(); gainMain.gain.value = 1.0; gainMain.connect(master);
  gainAccent = audioCtx.createGain(); gainAccent.gain.value = 1.6; gainAccent.connect(master);

  // Keep active when possible
  document.addEventListener('visibilitychange', ()=>{
    if (isRunning && audioCtx?.state==='suspended') audioCtx.resume();
  });
  // On iOS, a user gesture is required before audio; starting the metronome will resume if needed.
}

function makeTick(time, accented=false){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  // Timbre
  if (sound==='click'){ o.type='square'; o.frequency.value = accented? 2200 : 1800; }
  else if (sound==='wood'){ o.type='square'; o.frequency.value = accented? 1200 : 900; }
  else { o.type='sine'; o.frequency.setValueAtTime(accented? 220 : 180, time); } // "drum"
  // Short envelope
  g.gain.setValueAtTime(0.001, time);
  g.gain.exponentialRampToValueAtTime(accented?0.9:0.6, time+0.001);
  g.gain.exponentialRampToValueAtTime(0.001, time+0.05);
  o.connect(g); g.connect(accented?gainAccent:gainMain);
  o.start(time); o.stop(time+0.06);
}

function scheduler(){
  const lookahead = 0.07; // seconds
  const interval = 60.0 / playBpm;
  while (nextTime < audioCtx.currentTime + lookahead){
    const accentedBeat = accentOn && (count % 4 === 0);
    makeTick(nextTime, accentedBeat);
    nextTime += interval;
    count++;
  }
  if (isRunning) setTimeout(scheduler, 20);
}

function start(){
  initAudio();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  nextTime = audioCtx.currentTime + 0.06;
  count = 0;
  isRunning = true;
  scheduler();
}

function stop(){
  isRunning = false;
}

function setSpm(v){
  spm = Math.max(60, Math.min(300, Math.round(v)));
  const half = document.getElementById('halfRate').checked;
  playBpm = half ? spm/2 : spm;
  document.getElementById('spmInput').value = spm;
  document.getElementById('spmSlider').value = spm;
  document.getElementById('playBpmLabel').textContent = Math.round(playBpm);
  if (isRunning){ stop(); start(); }
}

// --- UI wiring ---
const toggleBtn = document.getElementById('toggle');
document.getElementById('spmSlider').oninput = e => setSpm(+e.target.value);
document.getElementById('spmInput').oninput = e => setSpm(+e.target.value);
document.getElementById('halfRate').onchange = () => setSpm(spm);

['minus10','minus5','minus1','plus1','plus5','plus10'].forEach(id=>{
  document.getElementById(id).onclick = ()=>{
    const delta = id.includes('minus') ? -parseInt(id.replace(/\D/g,'')) : parseInt(id.replace(/\D/g,''));
    setSpm(spm + delta);
  };
});

document.querySelectorAll('.preset').forEach(btn=>{
  btn.onclick = ()=> setSpm(+btn.dataset.spm);
});

document.getElementById('soundClick').onclick = ()=>{ sound='click'; };
document.getElementById('soundWood').onclick  = ()=>{ sound='wood'; };
document.getElementById('soundDrum').onclick  = ()=>{ sound='drum'; };
document.getElementById('accent').onclick     = ()=>{ accentOn = !accentOn; };

toggleBtn.onclick = ()=>{
  if (!isRunning){ start(); toggleBtn.textContent='Stop'; }
  else { stop(); toggleBtn.textContent='Start'; }
};

// initial state
setSpm(180);
</script>
</body>
</html>
